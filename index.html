<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Itachi vs Madara: Clash of Legends</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#111; overflow:hidden; font-family:Arial; touch-action: none; }
    canvas { display:block; image-rendering:pixelated; }
    #ui { position:absolute; top:0; left:0; width:100%; pointer-events:none; }
    .bar { height:20px; background:#333; margin:10px; border:2px solid #fff; position:relative; }
    .fill { height:100%; width:100%; transition:0.2s; }
    #health1 .fill { background:#e74c3c; }
    #health2 .fill { background:#e74c3c; }
    #chakra1 .fill { background:#3498db; }
    #chakra2 .fill { background:#3498db; }
    .label { position:absolute; top:0; left:5px; color:white; font-weight:bold; font-size:12px; }
    #controls { position:absolute; bottom:20px; left:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    button { width:60px; height:60px; background:rgba(255,255,255,0.2); border:2px solid #fff; border-radius:50%; color:white; font-weight:bold; font-size:10px; }
    #joy { position:absolute; bottom:20px; right:20px; width:100px; height:100px; background:rgba(255,255,255,0.1); border:2px solid #fff; border-radius:50%; }
    #knob { width:40px; height:40px; background:#fff; border-radius:50%; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
    #msg { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; font-size:24px; font-weight:bold; text-shadow:0 0 10px red; display:none; }
    @media (min-width:768px) { #controls { display:none; } }
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div id="ui">
    <div class="bar" id="health1"><div class="fill"></div><div class="label">Itachi HP</div></div>
    <div class="bar" id="chakra1"><div class="fill"></div><div class="label">Chakra</div></div>
    <div class="bar" id="health2"><div class="fill"></div><div class="label">Madara HP</div></div>
    <div class="bar" id="chakra2"><div class="fill"></div><div class="label">Chakra</div></div>
  </div>
  <div id="controls">
    <button onclick="p1.attack(1)">Light</button>
    <button onclick="p1.attack(2)">Heavy</button>
    <button onclick="p1.ability(1)">Fireball</button>
    <button onclick="p1.ability(2)">Genjutsu</button>
    <button onclick="p1.ultimate()" style="background:red">ULTIMATE</button>
  </div>
  <div id="joy"><div id="knob"></div></div>
  <div id="msg"></div>

  <script>
    const c = document.getElementById('c');
    const ctx = c.getContext('2d');
    c.width = window.innerWidth; c.height = window.innerHeight;

    // Players
    class Fighter {
      constructor(x, name, color, isPlayer) {
        this.x = x; this.y = 300; this.w = 60; this.h = 100;
        this.name = name; this.color = color; this.isPlayer = isPlayer;
        this.hp = 100; this.chakra = 0; this.maxChakra = 100;
        this.velX = 0; this.combo = 0; this.facing = x < 400 ? 1 : -1;
        this.anim = 0; this.frame = 0; this.shield = false;
        this.ultimateReady = false;
      }
      update() {
        this.x += this.velX;
        this.x = Math.max(50, Math.min(c.width-50, this.x));
        this.anim = (this.anim + 0.2) % 4;
        if (this.chakra < this.maxChakra) this.chakra += 0.15;
        if (this.chakra >= 100) this.ultimateReady = true;
        this.updateUI();
      }
      attack(type) {
        if (!this.isPlayer) return;
        if (type === 1) { this.combo = (this.combo + 1) % 3; playSFX('hit'); }
        if (type === 2 && this.combo === 2) { this.combo = 0; this.dealDamage(25); }
      }
      ability(id) {
        if (!this.isPlayer || this.chakra < 30) return;
        this.chakra -= 30;
        if (this.name === 'Itachi' && id === 1) fireball(this.x + 40*this.facing, this.y);
        if (this.name === 'Itachi' && id === 2) genjutsu();
        if (this.name === 'Madara' && id === 1) meteorStorm();
        if (this.name === 'Madara' && id === 2) this.shield = true, setTimeout(()=>this.shield=false, 3000);
      }
      ultimate() {
        if (!this.isPlayer || !this.ultimateReady) return;
        this.chakra = 0; this.ultimateReady = false;
        if (this.name === 'Itachi') tsukuyomi();
        else infiniteTsukuyomi();
      }
      dealDamage(dmg) {
        const target = this === p1 ? p2 : p1;
        if (target.shield) return;
        target.hp -= dmg;
        spawnDamage(target.x, target.y-50, dmg);
        playSFX('explosion');
        if (target.hp <= 0) gameOver(this.name + ' WINS!');
      }
      updateUI() {
        const h = this === p1 ? 'health1' : 'health2';
        const ch = this === p1 ? 'chakra1' : 'chakra2';
        document.querySelector('#'+h+' .fill').style.width = (this.hp/100*100)+'%';
        document.querySelector('#'+ch+' .fill').style.width = (this.chakra/100*100)+'%';
      }
    }

    const p1 = new Fighter(200, 'Itachi', '#e74c3c', true);
    const p2 = new Fighter(600, 'Madara', '#9b59b6', false);

    // Effects
    const particles = [];
    const damageTexts = [];

    function fireball(x, y) {
      particles.push({x, y, vx: 8*p1.facing, vy:0, life:60, color:'#f39c12', type:'fire'});
      playSFX('fire');
    }
    function genjutsu() { p2.velX = 0; setTimeout(()=>{if(p2.hp>0)p2.velX=2;}, 2000); playSFX('genjutsu'); }
    function meteorStorm() {
      for(let i=0;i<5;i++) setTimeout(()=>particles.push({x:p1.x+Math.random()*200-100, y:0, vx:0, vy:8, life:80, color:'#e67e22', type:'meteor'}), i*200);
    }
    function tsukuyomi() {
      zoom = 2; timeScale = 0.3; playSFX('tsukuyomi');
      setTimeout(()=>{ p2.dealDamage(80); zoom = 1; timeScale = 1; }, 3000);
    }
    function infiniteTsukuyomi() {
      zoom = 3; timeScale = 0.1; playSFX('infinite');
      setTimeout(()=>{ p1.dealDamage(999); zoom = 1; timeScale = 1; }, 4000);
    }

    function spawnDamage(x,y,dmg) {
      damageTexts.push({x,y,t:dmg,s:0,a:1});
    }

    // AI
    setInterval(()=>{
      if (p2.hp <= 0) return;
      const dist = Math.abs(p1.x - p2.x);
      if (dist < 100 && Math.random()<0.6) p2.attack(1);
      if (p2.chakra > 30 && Math.random()<0.3) p2.ability(Math.random()<0.5?1:2);
      if (p2.chakra >= 100 && Math.random()<0.8) p2.ultimate();
      p2.velX = p1.x > p2.x ? 2 : -2;
    }, 800);

    // Controls
    const joy = document.getElementById('joy');
    const knob = document.getElementById('knob');
    let joyActive = false, joyX=0, joyY=0;
    joy.addEventListener('pointerdown', e=>{
      joyActive = true;
      moveKnob(e);
    });
    document.addEventListener('pointermove', e=>{
      if (joyActive) moveKnob(e);
    });
    document.addEventListener('pointerup',()=>{ joyActive=false; knob.style.transform='translate(-50%,-50%)'; p1.velX=0; });
    function moveKnob(e) {
      const rect = joy.getBoundingClientRect();
      const cx = rect.left + 50, cy = rect.top + 50;
      let dx = e.clientX - cx, dy = e.clientY - cy;
      const dist = Math.min(30, Math.hypot(dx,dy));
      const angle = Math.atan2(dy, dx);
      dx = dist * Math.cos(angle); dy = dist * Math.sin(angle);
      knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
      p1.velX = dx/30 * 6;
      if (p1.velX !== 0) p1.facing = p1.velX > 0 ? 1 : -1;
    }

    // Keyboard
    const keys = {};
    window.onkeydown = e => keys[e.key.toLowerCase()] = true;
    window.onkeyup = e => keys[e.key.toLowerCase()] = false;
    setInterval(()=>{
      if (keys['a']) p1.velX = -5;
      else if (keys['d']) p1.velX = 5;
      else p1.velX *= 0.8;
      if (keys['j']) p1.attack(1);
      if (keys['k']) p1.attack(2);
      if (keys['u']) p1.ability(1);
      if (keys['i']) p1.ability(2);
      if (keys[' ']) p1.ultimate();
    }, 50);

    // Game Loop
    let zoom = 1, timeScale = 1;
    function loop() {
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0,0,c.width,c.height);

      // Background
      ctx.fillStyle = '#16213e';
      ctx.fillRect(0, 400, c.width, 200);

      // Update
      for (let i=particles.length-1; i>=0; i--) {
        const p = particles[i];
        p.x += p.vx * timeScale; p.y += p.vy * timeScale;
        p.life--;
        if (p.life <= 0) particles.splice(i,1);
        if (p.type === 'fire' && Math.abs(p.x - (p1===p1?p2:p1).x) < 50 && Math.abs(p.y - (p1===p1?p2:p1).y) < 50) {
          (p1===p1?p2:p1).dealDamage(15); particles.splice(i,1);
        }
      }

      // Draw fighters
      ctx.save();
      ctx.translate(c.width/2, c.height/2);
      ctx.scale(zoom, zoom);
      ctx.translate(-c.width/2, -c.height/2);

      [p1, p2].forEach(p=>{
        p.update();
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.scale(p.facing, 1);

        // Body
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w/2, -p.h, p.w, p.h);

        // Face
        ctx.fillStyle = '#f5d5b0';
        ctx.fillRect(-15, -90, 30, 40);

        // Eyes
        ctx.fillStyle = p.name==='Itachi' ? '#ff0000' : '#ffff00';
        ctx.fillRect(-10, -80, 8, 8);
        ctx.fillRect(2, -80, 8, 8);

        // Hair
        ctx.fillStyle = '#000';
        ctx.fillRect(-25, -100, 50, 30);

        // Shield
        if (p.shield) {
          ctx.strokeStyle = '#00ffff';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(0, -50, 60, 0, Math.PI*2);
          ctx.stroke();
        }

        ctx.restore();
      });

      // Particles
      particles.forEach(p=>{
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.life/10, 0, Math.PI*2);
        ctx.fill();
      });

      // Damage text
      damageTexts.forEach((d,i)=>{
        ctx.fillStyle = `rgba(255,0,0,${d.a})`;
        ctx.font = `${20+d.s}px Arial`;
        ctx.fillText('-'+d.t, d.x-20, d.y);
        d.y -= 1; d.s += 1; d.a -= 0.02;
        if (d.a <= 0) damageTexts.splice(i,1);
      });

      ctx.restore();

      requestAnimationFrame(loop);
    }

    // SFX
    function playSFX(type) {
      const audioCtx = new AudioContext();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      if (type==='hit') { o.frequency.value = 300; g.gain.value = 0.1; o.start(); o.stop(audioCtx.currentTime+0.05); }
      if (type==='fire') { o.frequency.value = 800; g.gain.value = 0.2; o.start(); o.stop(audioCtx.currentTime+0.3); }
      if (type==='genjutsu') { o.type='sine'; o.frequency.value = 200; g.gain.value = 0.3; o.start(); o.stop(audioCtx.currentTime+2); }
      if (type==='tsukuyomi') { o.type='sawtooth'; o.frequency.value = 100; g.gain.value = 0.5; o.start(); o.stop(audioCtx.currentTime+3); }
      if (type==='infinite') { o.type='square'; o.frequency.value = 50; g.gain.value = 0.8; o.start(); o.stop(audioCtx.currentTime+4); }
    }

    function gameOver(msg) {
      document.getElementById('msg').textContent = msg;
      document.getElementById('msg').style.display = 'block';
      setTimeout(()=>location.reload(), 5000);
    }

    loop();
    window.onresize = ()=>{ c.width = window.innerWidth; c.height = window.innerHeight; };
  </script>
</body>
</html>
